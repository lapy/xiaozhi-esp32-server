<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Xiaozhi Voice Service Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            background-color: #4285f4;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3367d6;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status {
            font-weight: bold;
        }
        #scriptStatus {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px;
            border-radius: 5px;
            display: block;
            z-index: 100;
            transition: all 0.3s ease;
        }
        #scriptStatus.info {
            background-color: #e8f0fe;
            color: #4285f4;
            border-left: 4px solid #4285f4;
        }
        #scriptStatus.success {
            background-color: #e6f4ea;
            color: #0f9d58;
            border-left: 4px solid #0f9d58;
        }
        #scriptStatus.error {
            background-color: #fce8e6;
            color: #db4437;
            border-left: 4px solid #db4437;
        }
        #debugInfo {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        #showDebug {
            margin-top: 10px;
            background-color: #f5f5f5;
            color: #444;
            font-size: 12px;
        }
        #audioMeter {
            margin-top: 10px;
            height: 20px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
            display: none;
        }
        #audioLevel {
            height: 100%;
            width: 0%;
            background-color: #4285f4;
            transition: width 0.1s;
        }
        .conversation {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: white;
            margin-top: 10px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        .user {
            background-color: #e2f2ff;
            margin-left: auto;
            margin-right: 10px;
            text-align: right;
        }
        .server {
            background-color: #f0f0f0;
            margin-right: auto;
            margin-left: 10px;
        }
        #serverUrl {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 60%;
            margin-right: 10px;
        }
        #messageInput {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 70%;
            margin-right: 10px;
        }
        .section {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Xiaozhi Voice Service Test</h2>
        
        <div id="scriptStatus" class="info">Loading Opus library...</div>
        
        <div class="section">
            <h3>WebSocket Connection <span id="connectionStatus">Not Connected</span></h3>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <input type="text" id="serverUrl" value="ws://127.0.0.1:8000/xiaozhi/v1/" placeholder="WebSocket Server Address">
                <button id="connectButton">Connect</button>
            </div>
        </div>
        
        <div class="section">
            <h3>Recording Test</h3>
            <button id="initAudio" style="background-color: #34a853;">Initialize Audio</button>
            <button id="testMic" style="background-color: #fbbc05;">Test Microphone</button>
            <p></p>
            <button id="start" disabled>Start Recording</button>
            <button id="stop" disabled>Stop Recording</button>
            <button id="play" disabled>Play Recording</button>
            <p>Recording Status: <span id="status">Standby, initializing...</span></p>
            <div id="audioMeter">
                <div id="audioLevel"></div>
            </div>
        </div>
        
        <div class="section">
            <h3>Text Message</h3>
            <div style="display: flex; align-items: center;">
                <input type="text" id="messageInput" placeholder="Enter message..." disabled>
                <button id="sendTextButton" disabled>Send</button>
            </div>
        </div>
        
        <div class="section">
            <h3>Conversation History</h3>
            <div id="conversation" class="conversation"></div>
        </div>
        
        <button id="showDebug">Show/Hide Debug Info</button>
        <div id="debugInfo"></div>
    </div>

    <script>
        // Define global variables to track library loading status
        window.opusLoaded = false;
        window.startButton = document.getElementById("start");
        window.stopButton = document.getElementById("stop");
        window.playButton = document.getElementById("play");
        window.statusLabel = document.getElementById("status");
        window.debugInfo = document.getElementById("debugInfo");
        window.audioContextReady = false;
        window.testMicActive = false;
        
        // Show/hide debug information
        document.getElementById("showDebug").addEventListener("click", function() {
            if (debugInfo.style.display === "none" || !debugInfo.style.display) {
                debugInfo.style.display = "block";
                this.textContent = "Hide Debug Info";
            } else {
                debugInfo.style.display = "none";
                this.textContent = "Show Debug Info";
            }
        });
        
        // Add initialize audio button event
        document.getElementById("initAudio").addEventListener("click", function() {
            initializeAudioSystem();
        });
        
        // Add test microphone button event
        document.getElementById("testMic").addEventListener("click", function() {
            if (window.testMicActive) {
                stopMicTest();
            } else {
                startMicTest();
            }
        });
        
        // Initialize audio system
        function initializeAudioSystem() {
            try {
                log("Initializing audio system...");
                // Create temporary AudioContext to trigger user authorization
                const tempContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000,
                    latencyHint: 'interactive'
                });
                
                // Create oscillator and play short sound
                const oscillator = tempContext.createOscillator();
                const gain = tempContext.createGain();
                gain.gain.value = 0.1; // Very small volume
                oscillator.connect(gain);
                gain.connect(tempContext.destination);
                oscillator.frequency.value = 440; // A4
                oscillator.start();
                
                // Stop after 0.2 seconds
                setTimeout(() => {
                    oscillator.stop();
                    // Close context
                    tempContext.close().then(() => {
                        log("Audio system initialized successfully", "success");
                        updateScriptStatus("Audio system activated", "success");
                        document.getElementById("initAudio").disabled = true;
                        document.getElementById("initAudio").textContent = "Audio Initialized";
                        window.audioContextReady = true;
                        
                        // If Opus is loaded, enable start recording button
                        if (window.opusLoaded) {
                            startButton.disabled = false;
                        }
                    });
                }, 200);
            } catch (err) {
                log("Failed to initialize audio system: " + err.message, "error");
                updateScriptStatus("Failed to initialize audio: " + err.message, "error");
            }
        }
        
        // Test microphone
        function startMicTest() {
            const audioMeter = document.getElementById("audioMeter");
            const audioLevel = document.getElementById("audioLevel");
            const testMicBtn = document.getElementById("testMic");
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log("Browser does not support microphone access", "error");
                return;
            }
            
            log("Starting microphone test...");
            audioMeter.style.display = "block";
            testMicBtn.textContent = "Stop Test";
            testMicBtn.style.backgroundColor = "#ea4335";
            window.testMicActive = true;
            
            // Create audio context
            const testContext = new (window.AudioContext || window.webkitAudioContext)();
            window.testContext = testContext;
            
            // Get microphone permission
            navigator.mediaDevices.getUserMedia({ 
                audio: { 
                    echoCancellation: true, 
                    noiseSuppression: true,
                    autoGainControl: true
                } 
            })
            .then(stream => {
                log("Microphone access permission obtained", "success");
                
                // Save stream for later closing
                window.testStream = stream;
                
                // Create audio analyzer
                const source = testContext.createMediaStreamSource(stream);
                const analyser = testContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                // Create volume display update function
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                function updateMeter() {
                    if (!window.testMicActive) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    
                    // Calculate volume level (0-100)
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    const level = Math.min(100, Math.max(0, average * 2));
                    
                    // Update volume meter
                    audioLevel.style.width = level + "%";
                    
                    // If there is sound, log it
                    if (level > 10) {
                        log(`Sound detected: ${level.toFixed(1)}%`);
                    }
                    
                    // Loop update
                    window.testMicAnimationFrame = requestAnimationFrame(updateMeter);
                }
                
                // Start update
                updateMeter();
            })
            .catch(err => {
                log("Microphone test failed: " + err.message, "error");
                window.testMicActive = false;
                testMicBtn.textContent = "Test Microphone";
                testMicBtn.style.backgroundColor = "#fbbc05";
                audioMeter.style.display = "none";
            });
        }
        
        // Stop microphone test
        function stopMicTest() {
            const audioMeter = document.getElementById("audioMeter");
            const testMicBtn = document.getElementById("testMic");
            
            log("Stop microphone test");
            window.testMicActive = false;
            testMicBtn.textContent = "Test Microphone";
            testMicBtn.style.backgroundColor = "#fbbc05";
            
            // Stop analyzer animation
            if (window.testMicAnimationFrame) {
                cancelAnimationFrame(window.testMicAnimationFrame);
            }
            
            // Stop microphone stream
            if (window.testStream) {
                window.testStream.getTracks().forEach(track => track.stop());
            }
            
            // Close test context
            if (window.testContext) {
                window.testContext.close();
            }
            
            // Hide volume meter
            audioMeter.style.display = "none";
        }
        
        // Add debug logs
        function log(message, type = "info") {
            console.log(message);
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement("div");
            entry.textContent = `[${time}] ${message}`;
            
            if (type === "error") {
                entry.style.color = "#db4437";
            } else if (type === "success") {
                entry.style.color = "#0f9d58";
            }
            
            debugInfo.appendChild(entry);
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // Update script status display
        function updateScriptStatus(message, type) {
            const statusElement = document.getElementById('scriptStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = type;
                statusElement.style.display = 'block';
            }
            log(message, type);
        }
        
        // Check if Opus library is loaded
        function checkOpusLoaded() {
            try {
                // Check if Module exists (global variable exported by local library)
                if (typeof Module === 'undefined') {
                    log("Module object does not exist", "error");
                    throw new Error('Opus library not loaded, Module object does not exist');
                }

                // Record Module object structure for debugging
                log("Module object structure: " + Object.keys(Module).join(", "));

                // Try to use global Module function
                if (typeof Module._opus_decoder_get_size === 'function') {
                    window.ModuleInstance = Module;
                    log('Opus library loaded successfully (using global Module)', "success");
                    updateScriptStatus('Opus library loaded successfully', 'success');
                    
                    // Enable start recording button
                    startButton.disabled = false;
                    statusLabel.textContent = "Standby";
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        const statusElement = document.getElementById('scriptStatus');
                        if (statusElement) statusElement.style.display = 'none';
                    }, 3000);
                    
                    window.opusLoaded = true;
                    return true;
                }

                // Try to use Module.instance
                if (typeof Module.instance !== 'undefined' && typeof Module.instance._opus_decoder_get_size === 'function') {
                    window.ModuleInstance = Module.instance;
                    log('Opus library loaded successfully (using Module.instance)', "success");
                    updateScriptStatus('Opus library loaded successfully', 'success');
                    
                    // Enable start recording button
                    startButton.disabled = false;
                    statusLabel.textContent = "Standby";
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        const statusElement = document.getElementById('scriptStatus');
                        if (statusElement) statusElement.style.display = 'none';
                    }, 3000);
                    
                    window.opusLoaded = true;
                    return true;
                }

                // Check if there are other export methods
                log("Available methods on Module: " + Object.getOwnPropertyNames(Module).filter(prop => typeof Module[prop] === 'function').join(", "));
                
                if (typeof Module.onRuntimeInitialized === 'function' || typeof Module.onRuntimeInitialized === 'undefined') {
                    log("Module.onRuntimeInitialized not yet executed, waiting for module initialization to complete...");
                    // Module may not have completed initialization, register callback
                    Module.onRuntimeInitialized = function() {
                        log("Opus library runtime initialization completed, rechecking");
                        checkOpusLoaded();
                    };
                    return false;
                }

                throw new Error('Opus decoding function not found, Module structure may be incorrect');
            } catch (err) {
                log(`Opus library loading failed: ${err.message}`, "error");
                updateScriptStatus(`Opus library loading failed: ${err.message}`, 'error');
                statusLabel.textContent = "Error: Opus library loading failed";
                return false;
            }
        }
        
        // Check browser capabilities and Opus library after page load
        window.addEventListener('load', function() {
            log("Page load completed, starting initialization...");
            updateScriptStatus('Initializing recording environment...', 'info');
            
            // Delay for a short time before checking to ensure library has time to load
            setTimeout(function checkAndRetry() {
                if (!checkOpusLoaded()) {
                    // If loading fails, retry after 5 seconds
                    log("Opus library loading failed, retrying in 5 seconds...");
                    updateScriptStatus('Opus library loading failed, retrying...', 'error');
                    setTimeout(checkAndRetry, 5000);
                }
            }, 1000);
        });

        // Prevent button misoperation
        document.getElementById("stop").disabled = true;
        document.getElementById("play").disabled = true;
    </script>
    <script src="./../libopus.js"></script>
    <script src="app.js"></script>
</body>
</html>
